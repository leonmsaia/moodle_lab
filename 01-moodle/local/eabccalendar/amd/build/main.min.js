define(["local_eabccalendar/fullcalendar","local_eabccalendar/daygrid","core/ajax","jquery","core/modal_factory","local_eabccalendar/moment","core/templates","local_eabccalendar/interaction","core/modal_events","core/str","local_eabccalendar/alertify"],(function(e,a,t,o,n,r,l,c,i,d,s){return{init:function(u,m){var f=document.getElementById("calendar"),v=new e.Calendar(f,{plugins:[a.default,c.default],themeSystem:"bootstrap",header:{center:"dayGridMonth,dayGridWeek,dayGridDay,timeGridFourDay"},views:{dayGridMonth:{}},buttonText:{today:M.util.get_string("today","local_eabccalendar"),month:M.util.get_string("month","local_eabccalendar"),week:M.util.get_string("week","local_eabccalendar"),day:M.util.get_string("day","local_eabccalendar"),list:M.util.get_string("list","local_eabccalendar")},locale:M.util.get_string("locale","local_eabccalendar"),events:function(e,a){t.call([{methodname:"mod_wseabcattendance_get_dates_sessions",args:{userid:u,courseid:m,start:r(e.startStr).format("X"),end:r(e.endStr).format("X")}}])[0].done((function(e){a(e.map((function(e){return{id:e.id,title:"Duración: "+e.duracion,start:r(e.sesiondate).format("YYYY-MM-DD HH:mm"),end:r(e.sesiondate).format("YYYY-MM-DD HH:mm"),color:e.color,textColor:"#FFFFFF",description:"This is a cool event",allow:e.direccion,classNames:e.nombre,overlap:e.courseid,constraint:e.estatus}})))})).fail((function(e){console.error(e)}))},eventClick:function(e){o("#fullCalModal");var a=e.event.classNames,t=r(e.event.start).format("DD-MM-YYYY"),c=e.event.id;if("bloqueos"==e.event.classNames)var m=e.event.id,f=e.event.title,v=e.event.borderColor,g="local_eabccalendar/bloqueados",h={id:m,fecha:t,h_inicio:E=e.event.allow,h_fin:v,motivo:f},b="Detalles del Bloqueo ";else{var y=null!=e.event.allow?e.event.allow:"No tiene",p=e.event.title.slice(9,18),Y=e.event.constraint,w=e.event.overlap,E=r(e.event.start).format("HH:mm");g="local_eabccalendar/planificado",b="Detalles de la Actividad ";if(r(e.event.start).diff(r(),"days")>=1)var D='<a href="../../mod/eabcattendance/focalizacion/view.php?id='+w+"&sesionid="+e.event.id+"&fecha="+t+"&hora="+E+' "><i class="icon fa fa-envelope"></i>Enviar correo empresa</a>';else D="Fecha limite de contacto expiró, No puede enviar email";h={fecha:t,actividad:a,direccion:y,h_inicio:E,duracion:p,estatus:Y,url:w,link:D,iduser:u,sesionid:c}}n.create({title:b,body:l.render(g,h),type:n.types.SAVE_CANCEL,large:!0}).then((function(a){a.show(),"bloqueos"==e.event.classNames?(a.setSaveButtonText(d.get_string("delete")),o(".modal-footer > .btn-primary").removeClass().addClass("btn btn-danger")):o(".modal-footer").remove(),a.getRoot().on(i.save,(function(){var e=document.getElementById("id").value;s.confirm(M.util.get_string("confirmDelete","local_eabccalendar"),(function(a){a&&_(e)}),(function(e){e&&s.error(M.util.get_string("cancel","local_eabccalendar"))})).set("labels",{ok:M.util.get_string("confirm","local_eabccalendar"),cancel:M.util.get_string("cancel","local_eabccalendar")}).setHeader(M.util.get_string("delete","local_eabccalendar"))})),a.getRoot().on(i.hidden,(function(){a.destroy()})),o(".modal").on("mousedown",(function(e){1===e.which&&a.hide()})),o(".modal-content").on("mousedown",(function(e){e.stopPropagation()}))})).catch(Notification.exception)},dateClick:function(e){var a=r(e.dateStr).format("DD-MM-YYYY");if(r().isSameOrBefore(e.dateStr)){var c=o("#create-modal");n.create({type:n.types.SAVE_CANCEL,title:"Bloquear calendario del día: "+a,body:l.render("local_eabccalendar/bloqueo_agenda",{})},c).done((function(a){a.show(),a.getRoot().on(i.save,(function(o){var n=document.getElementById("descripcion").value,r=document.getElementById("hora_desde").value,l=document.getElementById("hora_hasta").value;if(""==r||""==l)o.preventDefault(),i.cancel,document.getElementById("requeridos").innerHTML="Por favor coloque las horas requeridas";else if(r==l){o.preventDefault(),i.cancel,document.getElementById("requeridos").innerHTML="La hora de inicio y fin no puede ser igual"}else if(r>l){o.preventDefault(),i.cancel,document.getElementById("requeridos").innerHTML="La hora de inicio no puede ser mayor a la hora Hasta"}else{var c=t.call([{methodname:"local_wseabccalendar_agenda",args:{motivo:n,hora_desde:r,hora_hasta:l,fecha:e.dateStr}}]),d=document.getElementById("loader");d.setAttribute("style","display:block");var u=M.util.add_spinner(Y,Y.Node(".loader"));u.show(),c[0].done((function(e){e.estatus?location.reload():(d.setAttribute("style","display:none"),s.alert("Error","No se guardo, las horas solapan a una actividad planificada",(function(){s.error("Error")})),a.destroy())})).fail((function(e){u.hide(),d.setAttribute("style","display:none"),s.alert("Error","Error en el Back. Mensaje: "+e.errorcode.data+" Codido de error: "+e.errorcode.status,(function(){s.error("Error")})),a.destroy(),console.log(e)}))}})),a.getRoot().on(i.cancel,(function(e){a.destroy()}))}))}}});v.render();t.call([{methodname:"local_wseabccalendar_get_bloqueo_agenda",args:{userid:u}}])[0].done((function(e){e.map((function(e){var a=[{id:e.id,title:null==e.motivo?"No tiene":e.motivo,start:r(e.fecha+" "+e.hora_desde).format("YYYY-MM-DD HH:mm"),end:e.hora_hasta,allow:e.hora_desde,color:"#CCC000",textColor:"#FFFFFF",classNames:"bloqueos",borderColor:e.hora_hasta}];v.addEventSource(a)}))})).fail((function(e){console.error(e)}));var _=e=>{t.call([{methodname:"local_wseabccalendar_delete_bloqueo_agenda",args:{id:e}}])[0].done((function(e){location.reload()})).fail((function(e){console.error(e)}))}}}}));