define(['jquery','core/log','core/str','core/templates','core/notification','core/ajax','core/config'],function($,log,str,templates,notification,ajax,cfg){var KEYS={DOWN:40,ENTER:13,SPACE:32,ESCAPE:27,COMMA:44,UP:38};var uniqueId=$.now();var changeUser=function(get_userid,options,state,newSelection){var promises=ajax.call([{methodname:'local_rating_item_get_user_selected_rating',args:{userid:get_userid}}]);promises[0].done(function(response){context1=$.extend({items:{label:response[0].firstname+' ',value:response[0].userid}},options,state);templates.render('local_rating_item/form_autocomplete_selection',context1).then(function(html,js){templates.replaceNodeContents(newSelection,html,js)});$("#userid").val(response[0].userid);var context={image:response[0].image,firstname:response[0].firstname,lastname:response[0].lastname,email:response[0].email,userid:response[0].userid,courseid:response[0].courseid,cfg:cfg};templates.render('local_rating_item/rating_item_view_head',context).then(function(htmlhead,js){templates.replaceNodeContents($(".user-info"),htmlhead,js)}).fail(function(ex){console.log(ex)})}).fail(function(ex){console.error(ex)})}
var activateSelection=function(index,state){var selectionElement=$(document.getElementById(state.selectionId));var length=selectionElement.children('[aria-selected=true]').length;index=index%length;while(index<0){index+=length}
var element=$(selectionElement.children('[aria-selected=true]').get(index));var itemId=state.selectionId+'-'+index;selectionElement.children().attr('data-active-selection',!1).attr('id','');element.attr('data-active-selection',!0).attr('id',itemId);selectionElement.attr('aria-activedescendant',itemId);return $.Deferred().resolve()};var updateSelectionList=function(options,state,originalSelect){var pendingKey='form-autocomplete-updateSelectionList-'+state.inputId;M.util.js_pending(pendingKey);var items=[];var newSelection=$(document.getElementById(state.selectionId));var activeId=newSelection.attr('aria-activedescendant');var activeValue=!1;if(activeId){activeValue=$(document.getElementById(activeId)).attr('data-value')}
originalSelect.children('option').each(function(index,ele){if($(ele).prop('selected')){var label;if($(ele).data('html')){label=$(ele).data('html')}else{label=$(ele).html()}
var promises=ajax.call([{methodname:'local_rating_item_get_user_selected_rating',args:{userid:ele.value}}]);promises[0].done(function(response){$("#userid").val(response[0].userid);var context={image:response[0].image,firstname:response[0].firstname,lastname:response[0].lastname,email:response[0].email,userid:response[0].userid,courseid:response[0].courseid,cfg:cfg};templates.render('local_rating_item/rating_item_view_head',context).then(function(htmlhead,js){templates.replaceNodeContents($(".user-info"),htmlhead,js)}).fail(function(ex){console.log(ex)})}).fail(function(ex){console.error(ex)});items.push({label:label,value:$(ele).attr('value')});$("#change-right").click(function(){var isLastElementSelected=$('#id_selcursos > option:selected').index()==$('#mycars > option').length-1;if(!isLastElementSelected){$('#id_selcursos > option:selected').removeAttr('selected').next('option').attr('selected','selected')}else{$('#id_selcursos > option:selected').removeAttr('selected');$('#id_selcursos > option').first().attr('selected','selected')}
var userIdNext=$('#id_selcursos').children("option:selected").val();changeUser(userIdNext,options,state,newSelection)});$("#change-left").click(function(){var isFirstElementSelected=$('#id_selcursos > option:selected').index()==0;if(!isFirstElementSelected){$('#id_selcursos > option:selected').removeAttr('selected').prev('option').attr('selected','selected')}else{$('#id_selcursos > option:selected').removeAttr('selected');$('#id_selcursos > option').last().attr('selected','selected')}
var userIdNext=$('#id_selcursos').children("option:selected").val();changeUser(userIdNext,options,state,newSelection)})}});var context=$.extend({items:items},options,state);return templates.render('local_rating_item/form_autocomplete_selection',context).then(function(html,js){templates.replaceNodeContents(newSelection,html,js);if(activeValue!==!1){newSelection.children('[aria-selected=true]').each(function(index,ele){if($(ele).attr('data-value')===activeValue){activateSelection(index,state)}})}
return activeValue}).then(function(){return M.util.js_complete(pendingKey)}).catch(notification.exception)};var notifyChange=function(originalSelect){if(typeof M.core_formchangechecker!=='undefined'){M.core_formchangechecker.set_form_changed()}
originalSelect.change()};var deselectItem=function(options,state,item,originalSelect){var selectedItemValue=$(item).attr('data-value');if(options.multiple){originalSelect.children('option').each(function(index,ele){if($(ele).attr('value')==selectedItemValue){$(ele).prop('selected',!1);if($(ele).attr('data-iscustom')){$(ele).remove()}}})}
return updateSelectionList(options,state,originalSelect).then(function(){notifyChange(originalSelect);return})};var activateItem=function(index,state){var inputElement=$(document.getElementById(state.inputId));var suggestionsElement=$(document.getElementById(state.suggestionsId));var length=suggestionsElement.children('[aria-hidden=false]').length;index=index%length;while(index<0){index+=length}
var element=$(suggestionsElement.children('[aria-hidden=false]').get(index));var globalIndex=$(suggestionsElement.children('[role=option]')).index(element);var itemId=state.suggestionsId+'-'+globalIndex;suggestionsElement.children().attr('aria-selected',!1).attr('id','');element.attr('aria-selected',!0).attr('id',itemId);inputElement.attr('aria-activedescendant',itemId);var scrollPos=element.offset().top-suggestionsElement.offset().top+suggestionsElement.scrollTop()-(suggestionsElement.height()/2);return suggestionsElement.animate({scrollTop:scrollPos},100).promise()};var activateNextItem=function(state){var suggestionsElement=$(document.getElementById(state.suggestionsId));var element=suggestionsElement.children('[aria-selected=true]');var current=suggestionsElement.children('[aria-hidden=false]').index(element);return activateItem(current+1,state)};var activatePreviousSelection=function(state){var selectionsElement=$(document.getElementById(state.selectionId));var element=selectionsElement.children('[data-active-selection=true]');if(!element){return activateSelection(0,state)}
var current=selectionsElement.children('[aria-selected=true]').index(element);return activateSelection(current-1,state)};var activateNextSelection=function(state){var selectionsElement=$(document.getElementById(state.selectionId));var element=selectionsElement.children('[data-active-selection=true]');var current=0;if(element){current=selectionsElement.children('[aria-selected=true]').index(element);current=current+1}else{current=0}
return activateSelection(current,state)};var activatePreviousItem=function(state){var suggestionsElement=$(document.getElementById(state.suggestionsId));var element=suggestionsElement.children('[aria-selected=true]');var current=suggestionsElement.children('[aria-hidden=false]').index(element);return activateItem(current-1,state)};var closeSuggestions=function(state){var inputElement=$(document.getElementById(state.inputId));var suggestionsElement=$(document.getElementById(state.suggestionsId));inputElement.attr('aria-expanded',!1).attr('aria-activedescendant',state.selectionId);suggestionsElement.hide().attr('aria-hidden',!0);return $.Deferred().resolve()};var updateSuggestions=function(options,state,query,originalSelect){var pendingKey='form-autocomplete-updateSuggestions-'+state.inputId;M.util.js_pending(pendingKey);var inputElement=$(document.getElementById(state.inputId));var suggestionsElement=$(document.getElementById(state.suggestionsId));var matchingElements=!1;var suggestions=[];originalSelect.children('option').each(function(index,option){if($(option).prop('selected')!==!0){suggestions[suggestions.length]={label:option.innerHTML,value:$(option).attr('value')}}});var searchquery=state.caseSensitive?query:query.toLocaleLowerCase();var context=$.extend({options:suggestions},options,state);var returnVal=templates.render('core/form_autocomplete_suggestions',context).then(function(html,js){templates.replaceNode(suggestionsElement,html,js);suggestionsElement=$(document.getElementById(state.suggestionsId));suggestionsElement.show().attr('aria-hidden',!1);suggestionsElement.children().each(function(index,node){node=$(node);if((options.caseSensitive&&node.text().indexOf(searchquery)>-1)||(!options.caseSensitive&&node.text().toLocaleLowerCase().indexOf(searchquery)>-1)){node.show().attr('aria-hidden',!1);matchingElements=!0}else{node.hide().attr('aria-hidden',!0)}});inputElement.attr('aria-expanded',!0);if(originalSelect.attr('data-notice')){suggestionsElement.html(originalSelect.attr('data-notice'))}else if(matchingElements){if(!options.tags){activateItem(0,state)}}else{str.get_string('nosuggestions','form').done(function(nosuggestionsstr){suggestionsElement.html(nosuggestionsstr)})}
return suggestionsElement}).then(function(){return M.util.js_complete(pendingKey)}).catch(notification.exception);return returnVal};var createItem=function(options,state,originalSelect){var inputElement=$(document.getElementById(state.inputId));var query=inputElement.val();var tags=query.split(',');var found=!1;$.each(tags,function(tagindex,tag){tag=tag.trim();if(tag!==''){if(!options.multiple){originalSelect.children('option').prop('selected',!1)}
originalSelect.children('option').each(function(index,ele){if($(ele).attr('value')==tag){found=!0;$(ele).prop('selected',!0)}});if(!found){var option=$('<option>');option.append(document.createTextNode(tag));option.attr('value',tag);originalSelect.append(option);option.prop('selected',!0);option.attr('data-iscustom',!0)}}});return updateSelectionList(options,state,originalSelect).then(function(){notifyChange(originalSelect);return}).then(function(){inputElement.val('');return}).then(function(){return closeSuggestions(state)})};var selectCurrentItem=function(options,state,originalSelect){var inputElement=$(document.getElementById(state.inputId));var suggestionsElement=$(document.getElementById(state.suggestionsId));var selectedItemValue=suggestionsElement.children('[aria-selected=true]').attr('data-value');if(!options.multiple){originalSelect.children('option').prop('selected',!1)}
originalSelect.children('option').each(function(index,ele){if($(ele).attr('value')==selectedItemValue){$(ele).prop('selected',!0)}});return updateSelectionList(options,state,originalSelect).then(function(){notifyChange(originalSelect);return}).then(function(){if(options.closeSuggestionsOnSelect){inputElement.val('');return closeSuggestions(state)}else{inputElement.focus();return updateSuggestions(options,state,inputElement.val(),originalSelect)}})};var updateAjax=function(e,options,state,originalSelect,ajaxHandler){var pendingPromise=addPendingJSPromise('updateAjax');var query=$(e.currentTarget).val();ajaxHandler.transport(options.selector,query,function(results){var processedResults=ajaxHandler.processResults(options.selector,results);var existingValues=[];originalSelect.children('option').each(function(optionIndex,option){option=$(option);if(!option.prop('selected')){option.remove()}else{existingValues.push(String(option.attr('value')))}});if(!options.multiple&&originalSelect.children('option').length===0){var option=$('<option>');originalSelect.append(option)}
if($.isArray(processedResults)){$.each(processedResults,function(resultIndex,result){if(existingValues.indexOf(String(result.value))===-1){var option=$('<option>');option.append(result.label);option.attr('value',result.value);originalSelect.append(option)}});originalSelect.attr('data-notice','')}else{originalSelect.attr('data-notice',processedResults)}
pendingPromise.resolve(updateSuggestions(options,state,'',originalSelect))},function(error){pendingPromise.reject(error)});return pendingPromise};var addNavigation=function(options,state,originalSelect){var inputElement=$(document.getElementById(state.inputId));inputElement.on('keydown',function(e){var pendingJsPromise=addPendingJSPromise('addNavigation-'+state.inputId+'-'+e.keyCode);switch(e.keyCode){case KEYS.DOWN:if(!options.showSuggestions){pendingJsPromise.resolve();return!0}else if(inputElement.attr('aria-expanded')==="true"){pendingJsPromise.resolve(activateNextItem(state))}else{if(!inputElement.val()&&options.ajax){require([options.ajax],function(ajaxHandler){pendingJsPromise.resolve(updateAjax(e,options,state,originalSelect,ajaxHandler))})}else{pendingJsPromise.resolve(updateSuggestions(options,state,inputElement.val(),originalSelect))}}
e.preventDefault();return!1;case KEYS.UP:pendingJsPromise.resolve(activatePreviousItem(state));e.preventDefault();return!1;case KEYS.ENTER:var suggestionsElement=$(document.getElementById(state.suggestionsId));if((inputElement.attr('aria-expanded')==="true")&&(suggestionsElement.children('[aria-selected=true]').length>0)){pendingJsPromise.resolve(selectCurrentItem(options,state,originalSelect))}else if(options.tags){pendingJsPromise.resolve(createItem(options,state,originalSelect))}else{pendingJsPromise.resolve()}
e.preventDefault();return!1;case KEYS.ESCAPE:if(inputElement.attr('aria-expanded')==="true"){pendingJsPromise.resolve(closeSuggestions(state))}else{pendingJsPromise.resolve()}
e.preventDefault();return!1}
pendingJsPromise.resolve();return!0});inputElement.on('keypress',function(e){if(e.keyCode===KEYS.COMMA){if(options.tags){addPendingJSPromise('keypress-'+e.keyCode).resolve(createItem(options,state,originalSelect))}
e.preventDefault();return!1}
return!0});inputElement.closest('form').on('submit',function(){if(options.tags){addPendingJSPromise('form-autocomplete-submit').resolve(createItem(options,state,originalSelect))}
return!0});inputElement.on('blur',function(){var pendingPromise=addPendingJSPromise('form-autocomplete-blur');window.setTimeout(function(){var focusElement=$(document.activeElement);if(focusElement.attr('id')!=inputElement.attr('id')&&$('#'+state.inputId).length){if(options.tags){pendingPromise.then(function(){return createItem(options,state,originalSelect)}).catch()}
pendingPromise.then(function(){return closeSuggestions(state)}).catch()}
pendingPromise.resolve()},500)});if(options.showSuggestions){var arrowElement=$(document.getElementById(state.downArrowId));arrowElement.on('click',function(e){var pendingPromise=addPendingJSPromise('form-autocomplete-show-suggestions');inputElement.focus();if(!inputElement.val()&&options.ajax){require([options.ajax],function(ajaxHandler){pendingPromise.resolve(updateAjax(e,options,state,originalSelect,ajaxHandler))})}else{pendingPromise.resolve(updateSuggestions(options,state,inputElement.val(),originalSelect))}})}
var suggestionsElement=$(document.getElementById(state.suggestionsId));suggestionsElement.parent().prop("onclick",null).off("click");suggestionsElement.parent().on('click','[role=option]',function(e){var pendingPromise=addPendingJSPromise('form-autocomplete-parent');var element=$(e.currentTarget).closest('[role=option]');var suggestionsElement=$(document.getElementById(state.suggestionsId));var current=suggestionsElement.children('[aria-hidden=false]').index(element);activateItem(current,state).then(function(){return selectCurrentItem(options,state,originalSelect)}).then(function(){return pendingPromise.resolve()}).catch()});var selectionElement=$(document.getElementById(state.selectionId));selectionElement.on('click','[role=listitem]',function(e){var pendingPromise=addPendingJSPromise('form-autocomplete-clicks');pendingPromise.resolve(deselectItem(options,state,$(e.currentTarget),originalSelect))});selectionElement.on('keydown',function(e){var pendingPromise=addPendingJSPromise('form-autocomplete-keydown-'+e.keyCode);switch(e.keyCode){case KEYS.DOWN:e.preventDefault();pendingPromise.resolve(activateNextSelection(state));return!1;case KEYS.UP:e.preventDefault();pendingPromise.resolve(activatePreviousSelection(state));return!1;case KEYS.SPACE:case KEYS.ENTER:var selectedItem=$(document.getElementById(state.selectionId)).children('[data-active-selection=true]');if(selectedItem){e.preventDefault();pendingPromise.resolve(deselectItem(options,state,selectedItem,originalSelect))}
return!1}
pendingPromise.resolve();return!0});if(options.showSuggestions){if(options.ajax){require([options.ajax],function(ajaxHandler){var throttleTimeout=null;var inProgress=!1;var pendingKey='autocomplete-throttledhandler';var handler=function(e){throttleTimeout=null;inProgress=!0;updateAjax(e,options,state,originalSelect,ajaxHandler).then(function(){if(null===throttleTimeout){M.util.js_complete(pendingKey)}
inProgress=!1;return arguments[0]}).catch(notification.exception)};var throttledHandler=function(e){window.clearTimeout(throttleTimeout);if(inProgress){throttleTimeout=window.setTimeout(throttledHandler.bind(this,e),100);return}
if(throttleTimeout===null){M.util.js_pending(pendingKey)}
throttleTimeout=window.setTimeout(handler.bind(this,e),300)};inputElement.on("input",throttledHandler)})}else{inputElement.on('input',function(e){var query=$(e.currentTarget).val();var last=$(e.currentTarget).data('last-value');if(last!==query){updateSuggestions(options,state,query,originalSelect)}
$(e.currentTarget).data('last-value',query)})}}};var addPendingJSPromise=function(key){var pendingKey='form-autocomplete:'+key;M.util.js_pending(pendingKey);var pendingPromise=$.Deferred();pendingPromise.then(function(){M.util.js_complete(pendingKey);return arguments[0]}).catch(notification.exception);return pendingPromise};return{enhance:function(selector,tags,ajax,placeholder,caseSensitive,showSuggestions,noSelectionString,closeSuggestionsOnSelect){var options={selector:selector,tags:!1,ajax:!1,placeholder:placeholder,caseSensitive:!1,showSuggestions:!0,noSelectionString:noSelectionString};var pendingKey='autocomplete-setup-'+selector;M.util.js_pending(pendingKey);if(typeof tags!=="undefined"){options.tags=tags}
if(typeof ajax!=="undefined"){options.ajax=ajax}
if(typeof caseSensitive!=="undefined"){options.caseSensitive=caseSensitive}
if(typeof showSuggestions!=="undefined"){options.showSuggestions=showSuggestions}
if(typeof noSelectionString==="undefined"){str.get_string('noselection','form').done(function(result){options.noSelectionString=result}).fail(notification.exception)}
var originalSelect=$(selector);if(!originalSelect){log.debug('Selector not found: '+selector);M.util.js_complete(pendingKey);return!1}
originalSelect.css('visibility','hidden').attr('aria-hidden',!0);var state={selectId:originalSelect.attr('id'),inputId:'form_autocomplete_input-'+uniqueId,suggestionsId:'form_autocomplete_suggestions-'+uniqueId,selectionId:'form_autocomplete_selection-'+uniqueId,downArrowId:'form_autocomplete_downarrow-'+uniqueId};uniqueId++;options.multiple=originalSelect.attr('multiple');if(typeof closeSuggestionsOnSelect!=="undefined"){options.closeSuggestionsOnSelect=closeSuggestionsOnSelect}else{options.closeSuggestionsOnSelect=!options.multiple}
var originalLabel=$('[for='+state.selectId+']');var suggestions=[];originalSelect.children('option').each(function(index,option){suggestions[index]={label:option.innerHTML,value:$(option).attr('value')}});var context=$.extend({},options,state);context.options=suggestions;context.items=[];var collectedjs='';var renderInput=templates.render('local_rating_item/form_autocomplete_input',context).then(function(html,js){collectedjs+=js;return html});var renderDatalist=templates.render('core/form_autocomplete_suggestions',context).then(function(html,js){collectedjs+=js;return html});var renderSelection=templates.render('local_rating_item/form_autocomplete_selection',context).then(function(html,js){collectedjs+=js;$('.selector-rating').html(html);return html});return $.when(renderInput,renderDatalist,renderSelection).then(function(input,suggestions,selection){originalSelect.hide();originalSelect.after(suggestions);originalSelect.after(input);originalSelect.after(selection);templates.runTemplateJS(collectedjs);originalLabel.attr('for',state.inputId);addNavigation(options,state,originalSelect);var suggestionsElement=$(document.getElementById(state.suggestionsId));suggestionsElement.hide().attr('aria-hidden',!0);return}).then(function(){return updateSelectionList(options,state,originalSelect)}).then(function(){return M.util.js_complete(pendingKey)}).catch(function(error){M.util.js_complete(pendingKey);notification.exception(error)})}}})