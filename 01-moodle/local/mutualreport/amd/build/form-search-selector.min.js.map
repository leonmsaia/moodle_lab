{"version":3,"file":"form-search-selector.min.js","sources":["../src/form-search-selector.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Search user selector module.\n *\n * @module    local_mutualreport/form-search-selector\n * @copyright 2025 e-abclearning.com\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport * as Utils from 'local_mutualreport/utils';\n\n/**\n * Process the results for auto complete elements.\n *\n * @param {String} selector - The selector of the auto complete element.\n * @param {Array} results - An array of results returned by the transport function.\n * @return {Array} - A new array of user objects with value and label properties.\n */\nexport const processResults = (selector, results) => {\n    return results;\n};\n\n/**\n * Load the list of users matching the query and render the selector labels for them.\n *\n * @param {String} selector The selector of the auto complete element.\n * @param {String} query The query string.\n * @param {Function} success A callback function receiving an array of results.\n * @param {Function} failure A function to call in case of failure, receiving the error message.\n */\nexport const transport = (selector, query, success, failure)  => {\n    var promise;\n\n    // Search within specific course if known and if the 'search within' dropdown is set\n    // to search within course or activity.\n    var args = {query: query};\n\n    // Use a regular expression to find all attributes starting with \"field_\"\n    const fieldAttributes = $(selector).get(0).attributes; // Get the DOM element's attributes\n    for (let i = 0; i < fieldAttributes.length; i++) {\n\n        const attr = fieldAttributes[i];\n\n        // Get the value of the attribute if it starts with \"fieldwithdefault_\" and add it to the args\n        if (attr.name.startsWith('fieldwithdefault_')) {\n            let fieldname = attr.name.replace(\"fieldwithdefault_\", \"\");\n            var fieldvalue = $(selector).attr(attr.name);\n\n            var defaultvalue = 0;\n            var defaultfield = fieldAttributes.getNamedItem(fieldname + '_default');\n            if (defaultfield) {\n                defaultvalue = defaultfield.value;\n            }\n\n            args[fieldname] = Utils.getFirstValueFromSelectors(\n                [fieldvalue],\n                Utils.getUrlParameter(\n                    fieldname,\n                    defaultvalue\n                )\n            );\n        }\n\n        // Get the value of the attribute if it starts with \"field_\" and add it to the args\n        if (attr.name.startsWith('field_')) {\n            let fieldname = attr.name.replace(\"field_\", \"\");\n            var fieldvalue = $(selector).attr(attr.name);\n            args[fieldname] = Utils.getFirstValueFromSelectors([fieldvalue], 0);\n        }\n\n        // Get the value of the attribute if it starts with \"fieldstaticvalue_\" and add it to the args\n        if (attr.name.startsWith('fieldstaticvalue_')) {\n            let fieldname = attr.name.replace(\"fieldstaticvalue_\", \"\");\n            var fieldvalue = $(selector).attr(attr.name);\n            args[fieldname] = fieldvalue;\n        }\n\n        if (attr.name.startsWith('notgeturlparameter_')) {\n            let fieldname = attr.name.replace(\"notgeturlparameter_\", \"\");\n            var fieldvalue = $(selector).attr(attr.name);\n            args[fieldname] = !Utils.getUrlParameter(fieldvalue);\n        } else if (attr.name.startsWith('geturlparameter_')) {\n            let fieldname = attr.name.replace(\"geturlparameter_\", \"\");\n            var fieldvalue = $(selector).attr(attr.name);\n            args[fieldname] = Utils.getUrlParameter(fieldvalue);\n        }\n\n        if (attr.name.startsWith('notgetlastpathnameparameter_')) {\n            let fieldname = attr.name.replace(\"notgetlastpathnameparameter_\", \"\");\n            var fieldvalue = $(selector).attr(attr.name);\n            args[fieldname] = !Utils.getLastPathNameParameter([fieldvalue]);\n        } else if (attr.name.startsWith('getlastpathnameparameter_')) {\n            let fieldname = attr.name.replace(\"getlastpathnameparameter_\", \"\");\n            var fieldvalue = $(selector).attr(attr.name);\n            args[fieldname] = Utils.getLastPathNameParameter([fieldvalue]);\n        }\n\n        // Get the value of the attribute if it starts with \"fieldischecked_\" or \"fieldisnotchecked_\" and add it to the args\n        if (attr.name.startsWith('fieldischecked_') || attr.name.startsWith('fieldisnotchecked_')) {\n            const prefix = attr.name.startsWith('fieldischecked_') ? 'fieldischecked_' : 'fieldisnotchecked_';\n            const fieldname = attr.name.replace(prefix, \"\");\n            const fieldvalue = $(selector).attr(attr.name);\n            const isChecked = $(fieldvalue).is(\":checked\");\n\n            if ((prefix === 'fieldischecked_' && isChecked) || (prefix === 'fieldisnotchecked_' && !isChecked)) {\n                args[fieldname] = true;\n            } else {\n                args[fieldname] = false;\n            }\n        }\n\n    }\n\n    // Call AJAX request.\n    var methodname = $(selector).attr('methodname');\n\n    // Always have to return list with id. All other parameters are managed in the template.\n    promise = Ajax.call([{methodname: methodname, args: args}]);\n\n    // When AJAX request returns, handle the results.\n    promise[0].then(async function(results) {\n\n        const list = await Promise.all(results.map(async (element) => {\n            const template = $(selector).attr('template');\n            const label = await Templates.render(template, element); // Wait for the template.\n            return {\n                value: element.id,\n                label: label\n            };\n        }));\n        success(list);\n\n    }).fail(failure);\n};\n"],"names":["selector","results","query","success","failure","args","fieldAttributes","get","attributes","i","length","attr","name","startsWith","fieldname","replace","fieldvalue","defaultvalue","defaultfield","getNamedItem","value","Utils","getFirstValueFromSelectors","getUrlParameter","getLastPathNameParameter","prefix","isChecked","is","methodname","Ajax","call","then","async","list","Promise","all","map","template","label","Templates","render","element","id","fail"],"mappings":";;;;;;;25BAmC8B,CAACA,SAAUC,UAC9BA,2BAWc,CAACD,SAAUE,MAAOC,QAASC,eAK5CC,KAAO,CAACH,MAAOA,aAGbI,iBAAkB,mBAAEN,UAAUO,IAAI,GAAGC,eACtC,IAAIC,EAAI,EAAGA,EAAIH,gBAAgBI,OAAQD,IAAK,OAEvCE,KAAOL,gBAAgBG,MAGzBE,KAAKC,KAAKC,WAAW,qBAAsB,KACvCC,UAAYH,KAAKC,KAAKG,QAAQ,oBAAqB,QACnDC,YAAa,mBAAEhB,UAAUW,KAAKA,KAAKC,MAEnCK,aAAe,EACfC,aAAeZ,gBAAgBa,aAAaL,UAAY,YACxDI,eACAD,aAAeC,aAAaE,OAGhCf,KAAKS,WAAaO,MAAMC,2BACpB,CAACN,YACDK,MAAME,gBACFT,UACAG,kBAMRN,KAAKC,KAAKC,WAAW,UAAW,KAC5BC,UAAYH,KAAKC,KAAKG,QAAQ,SAAU,IACxCC,YAAa,mBAAEhB,UAAUW,KAAKA,KAAKC,MACvCP,KAAKS,WAAaO,MAAMC,2BAA2B,CAACN,YAAa,MAIjEL,KAAKC,KAAKC,WAAW,qBAAsB,KACvCC,UAAYH,KAAKC,KAAKG,QAAQ,oBAAqB,IACnDC,YAAa,mBAAEhB,UAAUW,KAAKA,KAAKC,MACvCP,KAAKS,WAAaE,cAGlBL,KAAKC,KAAKC,WAAW,uBAAwB,KACzCC,UAAYH,KAAKC,KAAKG,QAAQ,sBAAuB,IACrDC,YAAa,mBAAEhB,UAAUW,KAAKA,KAAKC,MACvCP,KAAKS,YAAcO,MAAME,gBAAgBP,iBACtC,GAAIL,KAAKC,KAAKC,WAAW,oBAAqB,KAC7CC,UAAYH,KAAKC,KAAKG,QAAQ,mBAAoB,IAClDC,YAAa,mBAAEhB,UAAUW,KAAKA,KAAKC,MACvCP,KAAKS,WAAaO,MAAME,gBAAgBP,eAGxCL,KAAKC,KAAKC,WAAW,gCAAiC,KAClDC,UAAYH,KAAKC,KAAKG,QAAQ,+BAAgC,IAC9DC,YAAa,mBAAEhB,UAAUW,KAAKA,KAAKC,MACvCP,KAAKS,YAAcO,MAAMG,yBAAyB,CAACR,kBAChD,GAAIL,KAAKC,KAAKC,WAAW,6BAA8B,KACtDC,UAAYH,KAAKC,KAAKG,QAAQ,4BAA6B,IAC3DC,YAAa,mBAAEhB,UAAUW,KAAKA,KAAKC,MACvCP,KAAKS,WAAaO,MAAMG,yBAAyB,CAACR,gBAIlDL,KAAKC,KAAKC,WAAW,oBAAsBF,KAAKC,KAAKC,WAAW,sBAAuB,OACjFY,OAASd,KAAKC,KAAKC,WAAW,mBAAqB,kBAAoB,qBACvEC,UAAYH,KAAKC,KAAKG,QAAQU,OAAQ,IACtCT,YAAa,mBAAEhB,UAAUW,KAAKA,KAAKC,MACnCc,WAAY,mBAAEV,YAAYW,GAAG,YAG/BtB,KAAKS,cADO,oBAAXW,QAAgCC,WAA0B,uBAAXD,SAAoCC,gBAU5FE,YAAa,mBAAE5B,UAAUW,KAAK,cAGxBkB,cAAKC,KAAK,CAAC,CAACF,WAAYA,WAAYvB,KAAMA,QAG5C,GAAG0B,MAAKC,eAAe/B,eAErBgC,WAAaC,QAAQC,IAAIlC,QAAQmC,KAAIJ,MAAAA,gBACjCK,UAAW,mBAAErC,UAAUW,KAAK,YAC5B2B,YAAcC,mBAAUC,OAAOH,SAAUI,eACxC,CACHrB,MAAOqB,QAAQC,GACfJ,MAAOA,WAGfnC,QAAQ8B,SAETU,KAAKvC"}